<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ¯ ×™×•×¦×¨ DFA ××™× ×˜×¨××§×˜×™×‘×™ | TeacherPython</title>

  <!-- Tailwind + Cytoscape -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>

  <link rel="stylesheet" href="/static/css/style.css">

  <style>
    /* ×‘×¡×™×¡ ×›×œ×œ×™: ×¤×•× ×˜ ×§×¨×™× ×•×¦×‘×¢ ×˜×§×¡×˜ ×›×”×” */
    body {
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      color: #111827; /* gray-900 */
    }

    #cy {
      width: 100%;
      height: 500px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }

    /* ×”×“×’×©×” ×‘×¦×”×•×‘ ×œ××¡×œ×•×œ ×”×¡×™××•×œ×¦×™×” */
    .highlight {
      background-color: #facc15 !important;
      line-color: #facc15 !important;
      target-arrow-color: #facc15 !important;
      transition: 0.25s ease;
    }

    /* ×˜×§×¡×˜ ×”×ª×™××•×¨ ×©×”××©×ª××© ×›×ª×‘ */
    #userInputText {
      font-size: 1.05rem;
      line-height: 1.7;
      color: #111827; /* ×›×”×” ×××•×“ */
      font-weight: 500;
      white-space: pre-wrap;
    }

    /* ×˜×§×¡×˜ trace ×©×œ ×”×¡×™××•×œ×¦×™×” */
    #trace {
      color: #111827;
      font-size: 0.95rem;
      line-height: 1.6;
      direction: ltr;
      text-align: left;
    }

    /* ×˜×§×¡×˜×™ ×”×”×¡×‘×¨ ×”×¤× ×™××™ */
    #explanationText,
    #logicText,
    #sourceText {
      color: #111827;
      font-size: 1rem;
      line-height: 1.8;
      white-space: pre-wrap;
    }

    /* ×©×“×•×ª ×§×œ×˜ ×©×œ ×”××©×ª××© â€“ ×˜×§×¡×˜ ×›×”×” ×™×•×ª×¨ */
    #description,
    #simInput {
      color: #111827;
      font-size: 1rem;
      line-height: 1.6;
    }

    #description::placeholder,
    #simInput::placeholder {
      color: #6b7280; /* gray-500 */
    }
  </style>
</head>

<body class="bg-gray-100">

<main class="max-w-5xl mx-auto bg-white shadow-2xl rounded-3xl p-10 border border-indigo-100 mt-6 fade-in">

  <!-- ×›×•×ª×¨×ª ×”×“×£ -->
  <h1 class="text-4xl font-extrabold text-indigo-700 mb-3 text-center">
    ğŸ¯ ×™×•×¦×¨ ××•×˜×•××˜×™× ×“×˜×¨××™× ×™×¡×˜×™×™× (DFA)
  </h1>

  <p class="text-gray-800 text-center text-lg mb-8">
    ×”×–×Ÿ ×ª×™××•×¨ ×©×¤×” ×˜×‘×¢×™×ª â€” ×•×”××¢×¨×›×ª ×ª×™×™×¦×¨ ×¢×‘×•×¨×š ××•×˜×•××˜ ××œ× + ×¡×™××•×œ×¦×™×”.
  </p>

  <!-- ×˜×•×¤×¡ ×™×¦×™×¨×ª DFA â€” ×ª××™×“ ×œ××¢×œ×” -->
  <form id="automatonForm" class="space-y-6">
    <textarea id="description" required
      placeholder="×œ×“×•×’××”: ×©×¤×ª ×›×œ ×”××™×œ×™× ×©××ª×—×™×œ×•×ª ×‘-aaa ×•××¡×ª×™×™××•×ª ×‘-b"
      class="w-full h-36 p-4 rounded-2xl border border-gray-300 focus:ring-4
             focus:ring-indigo-400 text-lg shadow-inner resize-none bg-white"></textarea>

    <div class="flex justify-center">
      <button type="submit"
        class="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700
               hover:to-purple-700 text-white font-bold py-3 px-10 rounded-2xl shadow-lg">
        ğŸš€ ×¦×•×¨ ××•×˜×•××˜ ×—×“×©
      </button>
    </div>
  </form>

  <!-- ×× ×™××¦×™×™×ª ×˜×¢×™× ×” -->
  <div id="loading" class="hidden text-center mt-6 text-indigo-600 font-medium">
    â³ ×‘×•× ×” ××ª ×”××•×˜×•××˜...
  </div>

  <!-- ×©×’×™××” ×›×œ×œ×™×ª -->
  <div id="errorBox" class="hidden mt-4 text-center text-red-600 font-semibold">
    ××™×¨×¢×” ×©×’×™××” ×‘×¢×ª ×™×¦×™×¨×ª ×”××•×˜×•××˜. × ×¡×” ×©×•×‘ ×‘×¢×•×“ ×¨×’×¢.
  </div>
  <!-- ×”×•×“×¢×” ×œ×©×¤×” ×œ× ×¨×’×•×œ×¨×™×ª -->
<div id="infoBox"
     class="hidden mt-6 text-center text-yellow-800 bg-yellow-100
            border border-yellow-300 rounded-xl p-4 font-semibold">
</div>


  <!-- ×ª×•×¦××•×ª ×™×¦×™×¨×ª ×”××•×˜×•××˜ -->
  <section id="result" class="hidden mt-10 fade-in">

    <h2 class="text-2xl font-bold text-indigo-700 mb-4 text-center">
      ğŸ“Œ ×”××•×˜×•××˜ ×©× ×•×¦×¨
    </h2>

    <!-- ×”×¦×’×ª ×”×©×¤×” ×©× ×•×¦×¨×” -->
    <div class="bg-indigo-50 border border-indigo-200 rounded-2xl p-4 mb-6">
      <p class="text-lg text-indigo-800 font-semibold">ğŸ”¹ ×”×©×¤×” ×©× ×•×¦×¨×” ×›×¢×ª:</p>
      <p id="userInputText" class="mt-1"></p>
    </div>

    <!-- ×”××•×˜×•××˜ -->
    <div id="cy"></div>

    <!-- ×¡×™××•×œ×¦×™×” -->
    <div class="mt-10 bg-indigo-50 border border-indigo-200 rounded-2xl p-6">
      <h3 class="text-xl font-semibold mb-3 text-indigo-800">ğŸ” ×¡×™××•×œ×¦×™×” ×¢×œ ×”××•×˜×•××˜</h3>

      <div class="flex flex-col md:flex-row items-stretch md:items-center gap-4 mb-4">
        <input id="simInput" placeholder="×”×›× ×¡ ××™×œ×” ×œ×¡×™××•×œ×¦×™×” (×œ×“×•×’××”: aaab)"
          class="flex-grow p-3 border rounded-xl shadow-inner text-lg bg-white" />

        <button type="button" onclick="simulateFast()"
          class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-xl shadow-md">
          âš¡ ×¡×™××•×œ×¦×™×” ××”×™×¨×”
        </button>

        <button type="button" onclick="simulateStepByStep()"
          class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-xl shadow-md">
          â–¶ï¸ ×¦×¢×“Ö¾××—×¨Ö¾×¦×¢×“
        </button>
      </div>

      <pre id="trace" class="bg-white rounded-xl p-4 shadow-inner"></pre>
    </div>

    <!-- ×”×¡×‘×¨ -->
    <div class="mt-8 bg-indigo-50 border border-indigo-200 rounded-2xl p-6">
      <p class="mb-2"><strong>ğŸ§© ×”×¡×‘×¨:</strong><br><span id="explanationText"></span></p>
      <p class="mt-4 mb-2"><strong>âš™ï¸ ×”×™×’×™×•×Ÿ ×¤× ×™××™:</strong><br><span id="logicText"></span></p>
      <p class="mt-4 mb-2"><strong>ğŸ” ××§×•×¨:</strong> <span id="sourceText" class="font-semibold text-indigo-700"></span></p>
      <p class="mt-2"><strong>ğŸ¯ ×“×™×•×§:</strong> <span id="accuracyText" class="font-semibold text-green-700"></span>%</p>
    </div>

  </section>

</main>

<!-- -------------------------------------------------------------------------------- -->
<!--                               JAVASCRIPT                                         -->
<!-- -------------------------------------------------------------------------------- -->

<script>
  let currentDFA = null;
  let cy = null;
  let stepInterval = null;

  /* ------------------------------
        ×©×œ×™×—×ª ×‘×§×©×” ×œ×‘× ×™×™×ª DFA
  ------------------------------ */
  const form = document.getElementById("automatonForm");
  const loadingEl = document.getElementById("loading");
  const resultEl = document.getElementById("result");
  const errorBox = document.getElementById("errorBox");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    errorBox.classList.add("hidden");
    loadingEl.classList.remove("hidden");
    resultEl.classList.add("hidden");

    const description = document.getElementById("description").value.trim();
    document.getElementById("userInputText").textContent = description;

    if (!description) {
      loadingEl.classList.add("hidden");
      errorBox.textContent = "×œ× ×”×•×–×Ÿ ×ª×™××•×¨ ×©×¤×”. ×× × ×›×ª×•×‘ ×ª×™××•×¨ ×•× ×¡×” ××—×“×©.";
      errorBox.classList.remove("hidden");
      console.warn("[DFA] Empty description submitted");
      return;
    }

    try {
      console.log("[DFA] Sending description to /generate_automaton:", description);

      const res = await fetch("/generate_automaton", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ description }),
      });

      if (!res.ok) {
        throw new Error("Response not OK: " + res.status + " " + res.statusText);
      }

const data = await res.json();
console.log("[DFA] Received DFA data:", data);

loadingEl.classList.add("hidden");

// ğŸ‘‰ ××§×¨×”: ×©×¤×” ×œ× ×¨×’×•×œ×¨×™×ª
if (data.status === "non_regular_language") {
  resultEl.classList.add("hidden");

  const infoBox = document.getElementById("infoBox");
  infoBox.textContent = data.user_message || "×”×©×¤×” ××™× ×” ×¨×’×•×œ×¨×™×ª.";
  infoBox.classList.remove("hidden");

  return; // â— ×œ× ×××©×™×›×™× ×œ×¦×™×•×¨ ××•×˜×•××˜
}

// ğŸ‘‰ ××—×¨×ª â€“ DFA ×¨×’×™×œ
document.getElementById("infoBox").classList.add("hidden");

currentDFA = data;
resultEl.classList.remove("hidden");

/* ×”×¦×’×ª ××™×“×¢ */
document.getElementById("explanationText").textContent = data.explanation || "";
document.getElementById("logicText").textContent = data.logic || "";
document.getElementById("sourceText").textContent = data.source || "";
document.getElementById("accuracyText").textContent = data.accuracy || "";

drawAutomaton(data);

    } catch (err) {
      console.error("[DFA] Error while generating automaton:", err);
      loadingEl.classList.add("hidden");
      errorBox.textContent = "××™×¨×¢×” ×©×’×™××” ×‘×¢×ª ×™×¦×™×¨×ª ×”××•×˜×•××˜. × ×¡×” ×©×•×‘ ×‘×¢×•×“ ×¨×’×¢.";
      errorBox.classList.remove("hidden");
    }
  });

  /* ------------------------------
          ×¦×™×•×¨ ××•×˜×•××˜ ×‘Ö¾Cytoscape
  ------------------------------ */
  function drawAutomaton(auto) {
    if (!auto) return;

    const elements = [];

    /* ××¦×‘×™× */
    auto.states.forEach((s) => {
      const isAccept = auto.accept_states.includes(s);
      elements.push({
        data: { id: s, label: s },
        classes: isAccept ? "accept" : "",
      });
    });

    /* ××¢×‘×¨×™× */
    for (const [src, edges] of Object.entries(auto.transitions)) {
      for (const [symbol, dst] of Object.entries(edges)) {
        elements.push({
          data: {
            id: `${src}_${dst}_${symbol}`,
            source: src,
            target: dst,
            label: symbol,
          },
        });
      }
    }

    cy = cytoscape({
      container: document.getElementById("cy"),
      elements,
      style: [
        {
          selector: "node",
          style: {
            "background-color": "#6366f1",
            "label": "data(label)",
            "color": "#ffffff",
            "font-size": "17px",
            "text-valign": "center",
            "border-width": 2,
            "border-color": "#312e81",
            "width": 50,
            "height": 50
          }
        },
        {
          selector: "node.accept",
          style: {
            "border-width": 6,
            "border-color": "#22c55e",
            "background-color": "#bbf7d0",
            "color": "#065f46"
          }
        },
        {
          selector: "node.highlight",
          style: {
            "background-color": "#facc15",
            "color": "#000000"
          }
        },
        {
          selector: "edge",
          style: {
            "curve-style": "bezier",
            "target-arrow-shape": "triangle",
            "label": "data(label)",
            "font-size": "14px",
            "line-color": "#6366f1",
            "target-arrow-color": "#4338ca",
            "text-margin-y": -10
          }
        },
        {
          selector: "edge.highlight",
          style: {
            "line-color": "#facc15",
            "target-arrow-color": "#facc15",
            "font-weight": "bold"
          }
        }
      ],
      layout: { name: "circle" }
    });

    cy.fit();
  }

  /* ------------------------------
            × ×™×§×•×™ ×”×“×’×©×•×ª
  ------------------------------ */
  function clearHighlights() {
    if (cy) {
      cy.nodes().removeClass("highlight");
      cy.edges().removeClass("highlight");
    }
  }

  /* ------------------------------
        ×¡×™××•×œ×¦×™×” ××”×™×¨×”
  ------------------------------ */
  function simulateFast() {
    if (!currentDFA) return;

    clearInterval(stepInterval);
    clearHighlights();

    const word = document.getElementById("simInput").value.trim();
    console.log("[DFA] simulateFast - word:", word);

    if (!word) {
      document.getElementById("trace").textContent = "×œ× ×”×•×–× ×” ××™×œ×” ×œ×¡×™××•×œ×¦×™×”.";
      return;
    }

    let state = currentDFA.start_state;
    let trace = `Start at: ${state}\n`;

    cy.$id(state).addClass("highlight");

    for (const symbol of word) {
      const next = currentDFA.transitions[state]?.[symbol];

      if (!next) {
        trace += `âŒ ××™×Ÿ ××¢×‘×¨ ××”××¦×‘ ${state} ×¢×‘×•×¨ '${symbol}'\n`;
        document.getElementById("trace").textContent = trace;
        return;
      }

      const edgeId = `${state}_${next}_${symbol}`;
      cy.$id(edgeId).addClass("highlight");

      trace += `${state} --${symbol}--> ${next}\n`;
      state = next;

      cy.$id(state).addClass("highlight");
    }

    trace += `\nFinal state: ${state}\n`;

    if (currentDFA.accept_states.includes(state))
      trace += "âœ” ×”××™×œ×” ××ª×§×‘×œ×ª!";
    else
      trace += "âŒ ×”××™×œ×” × ×“×—×™×ª!";

    document.getElementById("trace").textContent = trace;
  }

  /* ------------------------------
      ×¡×™××•×œ×¦×™×” ×¦×¢×“Ö¾××—×¨Ö¾×¦×¢×“
  ------------------------------ */
  function simulateStepByStep() {
    if (!currentDFA) return;

    clearHighlights();
    clearInterval(stepInterval);

    const word = document.getElementById("simInput").value.trim();
    console.log("[DFA] simulateStepByStep - word:", word);

    if (!word) {
      document.getElementById("trace").textContent = "×œ× ×”×•×–× ×” ××™×œ×” ×œ×¡×™××•×œ×¦×™×”.";
      return;
    }

    let state = currentDFA.start_state;
    let index = 0;
    let trace = `Start at: ${state}\n`;

    cy.$id(state).addClass("highlight");
    document.getElementById("trace").textContent = trace;

    stepInterval = setInterval(() => {
      if (index >= word.length) {
        clearInterval(stepInterval);

        trace += `\nFinal state: ${state}\n`;
        trace += currentDFA.accept_states.includes(state)
          ? "âœ” ×”××™×œ×” ××ª×§×‘×œ×ª!"
          : "âŒ ×”××™×œ×” × ×“×—×™×ª!";

        document.getElementById("trace").textContent = trace;
        return;
      }

      const symbol = word[index];
      const next = currentDFA.transitions[state]?.[symbol];

      if (!next) {
        trace += `âŒ ××™×Ÿ ××¢×‘×¨ ××”××¦×‘ ${state} ×¢×‘×•×¨ '${symbol}'\n`;
        document.getElementById("trace").textContent = trace;
        clearInterval(stepInterval);
        return;
      }

      const edgeId = `${state}_${next}_${symbol}`;
      cy.$id(edgeId).addClass("highlight");

      trace += `${state} --${symbol}--> ${next}\n`;
      state = next;

      cy.nodes().removeClass("highlight");
      cy.$id(state).addClass("highlight");

      document.getElementById("trace").textContent = trace;

      index++;
    }, 600);
  }

</script>

</body>
</html>
