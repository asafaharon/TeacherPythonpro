<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ“š ×™×•×¦×¨ ××•×˜×•××˜ ××—×¡× ×™×ª (NPDA) | TeacherPython</title>

  <!-- TailwindCSS & Cytoscape -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>

  <style>
    body {
      font-family: 'Rubik', 'Segoe UI', Tahoma, sans-serif;
      background: linear-gradient(135deg, #eef2ff, #c7d2fe);
      min-height: 100vh;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
    }

    main {
      max-width: 1100px;
      width: 100%;
    }

    #cy {
      width: 100%;
      height: 500px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .fade-in {
      animation: fadeIn 0.7s ease forwards;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .node-hover:hover {
      transform: scale(1.05);
      transition: 0.2s;
    }

    .stack-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 32px;
      height: 32px;
      border-radius: 999px;
      background: #4f46e5;
      color: #fff;
      font-weight: 600;
      margin-left: 6px;
    }

    .stack-badge-bottom {
      background: #a5b4fc;
      color: #1e293b;
    }

    /* ×˜×‘×œ×ª ××¢×‘×¨×™× â€“ ×”×“×’×©×” ×‘×©×•×¨×” ×©× ×‘×—×¨×” */
    .transition-row--active {
      background-color: #e0ecff;
    }

    /* ×”×“×’×©×ª ×§×©×ª */
    .edge--active {
      line-color: #f97316 !important;
      target-arrow-color: #f97316 !important;
      width: 4px !important;
    }

    /* Tooltip ×œ×§×©×ª×•×ª */
    #edgeTooltip {
      position: fixed;
      pointer-events: none;
      background: #111827;
      color: #f9fafb;
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 12px;
      z-index: 1000;
      opacity: 0;
      transform: translateY(-4px);
      transition: opacity 0.15s ease, transform 0.15s ease;
      max-width: 260px;
      direction: rtl;
      white-space: pre-line;
    }

    /* ×× ×™××¦×™×•×ª ××—×¡× ×™×ª */
    @keyframes stackPush {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes stackPopFlash {
      from {
        background-color: #fee2e2;
      }
      to {
        background-color: transparent;
      }
    }

    .stack-push {
      animation: stackPush 0.25s ease-out;
    }

    .stack-pop-flash {
      animation: stackPopFlash 0.3s ease-out;
    }

    @media (max-width: 768px) {
      body {
        padding: 16px;
      }
      main {
        padding: 12px !important;
      }
      #cy {
        height: 380px;
      }
    }
  </style>
</head>

<body>
  <div id="edgeTooltip"></div>

  <main class="w-full bg-white shadow-2xl rounded-3xl p-6 md:p-10 border border-indigo-100 fade-in">
    <h1 class="text-3xl md:text-4xl font-extrabold text-indigo-700 mb-3 text-center">
      ğŸ“š ×™×•×¦×¨ ××•×˜×•××˜ ××—×¡× ×™×ª (NPDA) ××©×¤×” ×˜×‘×¢×™×ª
    </h1>
    <p class="text-gray-600 text-center text-lg mb-8">
      ×”×–×Ÿ ×ª×™××•×¨ ××™×œ×•×œ×™ ×©×œ ×©×¤×” ×¤×•×¨××œ×™×ª (×’× ×‘×¢×‘×¨×™×ª), ×”××¢×¨×›×ª ×ª×‘× ×” ×¢×‘×•×¨×š NPDA ×•×ª××¤×©×¨ ×œ×‘×“×•×§ ××—×¨×•×–×•×ª ×‘×–××Ÿ ×××ª.
    </p>

    <!-- ×˜×•×¤×¡ ×§×œ×˜ ×œ×™×¦×™×¨×ª PDA -->
    <form id="pdaForm" class="space-y-6">
      <textarea id="description" required
        placeholder="×œ×“×•×’××”: ×›×œ ×”××™×œ×™× ××”×¦×•×¨×” a^n b^n (××•×ª×” ×›××•×ª ×©×œ a ×•××—×¨×™×” ××•×ª×” ×›××•×ª ×©×œ b)"
        class="w-full h-36 p-4 rounded-2xl border border-gray-300 focus:ring-4 focus:ring-indigo-400 focus:outline-none text-gray-800 resize-none text-lg placeholder-gray-400 shadow-inner transition"></textarea>

      <div class="flex flex-col md:flex-row gap-3 justify-center">
        <button type="submit"
          class="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-3 px-10 rounded-2xl shadow-lg transition transform hover:scale-105">
          ğŸš€ ×¦×•×¨ NPDA
        </button>

        <button type="button" id="exportPngBtn"
          class="bg-white border border-indigo-300 text-indigo-700 font-semibold py-3 px-6 rounded-2xl shadow-sm hover:bg-indigo-50 transition">
          ğŸ“· ×™×¦×•× ×ª××•× ×ª ×’×¨×£ (PNG)
        </button>
      </div>
    </form>

    <div id="loading" class="hidden text-center mt-6 text-indigo-600 font-medium">
      â³ ×”××¢×¨×›×ª ×™×•×¦×¨×ª ××ª ××•×˜×•××˜ ×”××—×¡× ×™×ª, ×× × ×”××ª×Ÿ...
    </div>

    <!-- ×ª×•×¦××” -->
    <section id="result" class="hidden mt-10 fade-in">
      <div class="grid grid-cols-1 lg:grid-cols-[2fr,minmax(0,1fr)] gap-4 mb-4">
        <div>
          <div id="cy"></div>

          <!-- ××’×“×” -->
          <div class="flex flex-wrap justify-center gap-4 mt-4 text-xs md:text-sm text-gray-700">
            <div class="flex items-center gap-2">
              <div class="w-4 h-4 bg-indigo-500 rounded-full border border-indigo-900"></div>
              <span>××¦×‘ ×¨×’×™×œ</span>
            </div>
            <div class="flex items-center gap-2">
              <div class="w-4 h-4 bg-green-200 border-4 border-green-500 rounded-full"></div>
              <span>××¦×‘ ××§×‘×œ</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="w-4 h-0.5 rounded bg-orange-500 inline-block"></span>
              <span>××¢×‘×¨ Îµ</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="w-4 h-0.5 rounded bg-blue-500 inline-block"></span>
              <span>Push ×‘×œ×‘×“</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="w-4 h-0.5 rounded bg-red-500 inline-block"></span>
              <span>Pop ×‘×œ×‘×“</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="w-4 h-0.5 rounded bg-purple-500 inline-block"></span>
              <span>Push + Pop</span>
            </div>
          </div>
        </div>

        <!-- ××™×“×¢ ×¢×œ ××¦×‘ × ×‘×—×¨ -->
        <aside class="bg-indigo-50 border border-indigo-200 rounded-2xl p-4 text-sm text-gray-800 shadow-sm">
          <h2 class="text-base md:text-lg font-bold text-indigo-800 mb-2">ğŸ§  ××™×“×¢ ×¢×œ ××¦×‘</h2>
          <div id="stateInfo">
            <p class="text-gray-500 text-sm">×œ×—×¥ ×¢×œ ××¦×‘ ×‘×’×¨×£ ×œ×§×‘×œ×ª ×¤×¨×˜×™× ×¢×œ×™×•.</p>
          </div>
        </aside>
      </div>

      <!-- ×˜×‘×œ×ª ××¢×‘×¨×™× -->
      <div class="mt-4 bg-white border border-indigo-100 rounded-2xl p-4 shadow-sm overflow-x-auto">
        <h2 class="text-lg font-semibold text-indigo-800 mb-3">
          ğŸ“‹ ×¨×©×™××ª ×”××¢×‘×¨×™× (Transitions)
        </h2>
        <table class="min-w-full text-sm text-gray-800">
          <thead>
            <tr class="border-b">
              <th class="px-3 py-2 text-right font-semibold">#</th>
              <th class="px-3 py-2 text-right font-semibold">×Ö¾××¦×‘</th>
              <th class="px-3 py-2 text-right font-semibold">××œ ××¦×‘</th>
              <th class="px-3 py-2 text-right font-semibold">× ×§×¨× (read)</th>
              <th class="px-3 py-2 text-right font-semibold">× ×©×œ×£ (pop)</th>
              <th class="px-3 py-2 text-right font-semibold">× ×™×“×—×£ (push)</th>
            </tr>
          </thead>
          <tbody id="transitionTableBody"></tbody>
        </table>
        <p class="mt-2 text-xs text-gray-500">
          ğŸ’¡ ×˜×™×¤: ×œ×—×¥ ×¢×œ ×§×©×ª ×‘×’×¨×£ ×›×“×™ ×œ×”×“×’×™×© ××ª ×©×•×¨×ª ×”××¢×‘×¨ ×”××ª××™××” ×‘×˜×‘×œ×” â€“ ××• ×œ×—×¥ ×¢×œ ×©×•×¨×” ×‘×˜×‘×œ×” ×›×“×™ ×œ×”×“×’×™×© ××ª ×”×§×©×ª ×”××ª××™××” ×‘×’×¨×£.
        </p>
      </div>

      <p class="text-center text-indigo-700 mt-6 text-lg font-semibold">
        â„¹ï¸ ×”××•×˜×•××˜ ××©×ª××© ×‘××—×¡× ×™×ª ×¤× ×™××™×ª â€“ × ×™×ª×Ÿ ×œ×¨××•×ª ××ª ×”×©×™× ×•×™×™× ×‘××—×¡× ×™×ª ×‘×›×œ ×¦×¢×“ ×¡×™××•×œ×¦×™×”.
      </p>

      <!-- ×ª×™×‘×ª ××™×“×¢ ×¢×œ ×”×©×¤×” -->
      <div class="mt-6 bg-indigo-50 border border-indigo-200 rounded-2xl p-6 text-gray-800 text-right shadow-sm">
        <p><strong>ğŸ§© ××” ×”×©×¤×”?</strong><br><span id="explanationText"></span></p>
        <p class="mt-4"><strong>âš™ï¸ ×”×”×™×’×™×•×Ÿ:</strong><br><span id="logicText"></span></p>

        <p class="mt-6"><strong>ğŸ” ××§×•×¨ ×”××•×˜×•××˜:</strong>
          <span id="sourceText" class="font-semibold text-indigo-700"></span>
        </p>

        <p class="mt-2"><strong>ğŸ¯ ×¨××ª ×“×™×•×§ (×”×¢×¨×›×ª ××•×“×œ):</strong>
          <span id="accuracyText" class="font-semibold text-green-700"></span>%
        </p>
      </div>

      <!-- ××–×•×¨ ×¡×™××•×œ×¦×™×” -->
      <section class="mt-8 bg-indigo-50 border border-indigo-200 rounded-2xl p-6 shadow-sm">
        <h2 class="text-2xl font-bold text-indigo-800 mb-4">ğŸ§ª ×¡×™××•×œ×¦×™×” ×¢×œ ××—×¨×•×–×ª</h2>
        <p class="text-gray-700 mb-4">
          ×”×›× ×¡ ××—×¨×•×–×ª ×¢×œ ×’×‘×™ ×”××œ×¤×‘×™×ª ×©×”-NPDA ××©×ª××© ×‘×•, ×•×¦×¤×” ×‘×”×¨×¦×” ×•×‘××¦×‘ ×”××—×¡× ×™×ª ×‘×›×œ ×¦×¢×“.
        </p>

        <form id="simulateForm" class="flex flex-col md:flex-row gap-4 items-center">
          <input id="wordInput" type="text" required
                 placeholder="×œ×“×•×’××”: aaabbb"
                 class="flex-1 w-full md:w-auto rounded-xl border border-gray-300 px-4 py-2 focus:ring-2 focus:ring-indigo-400 focus:outline-none">
          <button type="submit"
                  class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-6 py-2 rounded-xl shadow">
            â–¶ï¸ ×”×¨×¥ ×¡×™××•×œ×¦×™×”
          </button>
        </form>

        <p id="simulateResult" class="mt-4 text-lg font-semibold"></p>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Trace -->
          <div>
            <h3 class="font-bold text-indigo-800 mb-2">ğŸ” Trace ×©×œ ×”×¦×¢×“×™×</h3>
            <pre id="traceOutput"
                 class="bg-white border border-indigo-100 rounded-xl p-3 text-sm text-gray-800 overflow-auto max-h-64"></pre>
          </div>

          <!-- Stack viewer -->
          <div>
            <h3 class="font-bold text-indigo-800 mb-2">ğŸ“¦ ××¦×‘ ×”××—×¡× ×™×ª ×‘×¦×¢×“ ×”××—×¨×•×Ÿ</h3>
            <div id="stackView"
                 class="bg-white border border-indigo-100 rounded-xl p-4 text-sm text-gray-800 min-h-[60px] flex flex-wrap items-center">
              <span class="text-gray-500">×”×¨×¥ ×¡×™××•×œ×¦×™×” ×›×“×™ ×œ×¨××•×ª ××ª ×”××—×¡× ×™×ª.</span>
            </div>
          </div>
        </div>
      </section>
    </section>
  </main>

  <script>
    const pdaForm = document.getElementById('pdaForm');
    const loading = document.getElementById('loading');
    const result = document.getElementById('result');
    const cyDiv = document.getElementById('cy');
    const explanationText = document.getElementById('explanationText');
    const logicText = document.getElementById('logicText');
    const sourceText = document.getElementById('sourceText');
    const accuracyText = document.getElementById('accuracyText');

    const simulateForm = document.getElementById('simulateForm');
    const wordInput = document.getElementById('wordInput');
    const simulateResult = document.getElementById('simulateResult');
    const traceOutput = document.getElementById('traceOutput');
    const stackView = document.getElementById('stackView');

    const transitionTableBody = document.getElementById('transitionTableBody');
    const stateInfo = document.getElementById('stateInfo');
    const exportPngBtn = document.getElementById('exportPngBtn');
    const edgeTooltip = document.getElementById('edgeTooltip');

    let cy = null;
    let currentPda = null;
    let prevStackForAnimation = [];

    pdaForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loading.classList.remove('hidden');
      result.classList.add('hidden');
      cyDiv.innerHTML = '';
      simulateResult.textContent = '';
      traceOutput.textContent = '';
      stackView.innerHTML = '<span class="text-gray-500">×”×¨×¥ ×¡×™××•×œ×¦×™×” ×›×“×™ ×œ×¨××•×ª ××ª ×”××—×¡× ×™×ª.</span>';
      stackView.classList.remove('stack-pop-flash');
      if (transitionTableBody) {
        transitionTableBody.innerHTML = '';
      }
      if (stateInfo) {
        stateInfo.innerHTML = '<p class="text-gray-500 text-sm">×œ×—×¥ ×¢×œ ××¦×‘ ×‘×’×¨×£ ×œ×§×‘×œ×ª ×¤×¨×˜×™× ×¢×œ×™×•.</p>';
      }
      currentPda = null;
      prevStackForAnimation = [];

      const description = document.getElementById('description').value;

      try {
        const res = await fetch('/pda/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({ description })
        });

        const data = await res.json();
        loading.classList.add('hidden');

        if (data.type === 'none') {
          cyDiv.innerHTML = `
            <div class="bg-red-100 border-4 border-red-500 text-red-900 rounded-xl p-8 mt-6 text-center shadow-lg">
              <h2 class="text-3xl font-extrabold mb-2">ğŸš« ×œ× × ×‘× ×” NPDA</h2>
              <p>${data.explanation || '×œ× × ×™×ª×Ÿ ×”×™×” ×œ×‘× ×•×ª ××•×˜×•××˜ ××—×¡× ×™×ª ×¢×‘×•×¨ ×”×ª×™××•×¨ ×©× ×™×ª×Ÿ.'}</p>
            </div>`;
          result.classList.remove('hidden');
          return;
        }

        currentPda = data;

        drawPdaGraph(data);
        renderTransitionTable(data);

        explanationText.textContent = data.explanation || "×œ× × ×™×ª× ×” ×”×¡×‘×¨.";
        logicText.textContent = data.logic || "××™×Ÿ ×ª×™××•×¨ ×©×œ ×”×”×™×’×™×•×Ÿ.";
        sourceText.textContent = data.source || "model";
        accuracyText.textContent = data.accuracy ?? "-";

        result.classList.remove('hidden');
      } catch (err) {
        console.error(err);
        loading.classList.add('hidden');
        alert("âŒ ×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª.");
      }
    });

    function classifyEdgeKind(read, pop, pushList) {
      const isEps = (read === '' || read === 'Îµ');
      const hasPop = (pop !== '' && pop !== 'Îµ');
      const hasPush = (Array.isArray(pushList) && pushList.length > 0);

      if (isEps) return 'epsilon';
      if (hasPop && hasPush) return 'pop_push';
      if (hasPop && !hasPush) return 'pop_only';
      if (!hasPop && hasPush) return 'push_only';
      return 'other';
    }

    function drawPdaGraph(pda) {
      const elements = [];

      (pda.states || []).forEach(s => {
        const isAccept = (pda.accept_states || []).includes(s);
        elements.push({
          data: { id: s, label: s },
          classes: isAccept ? 'accept' : 'node-hover'
        });
      });

      (pda.transitions || []).forEach((t, idx) => {
        const read = (t.read === '' || t.read == null) ? 'Îµ' : t.read;
        const pop  = (t.pop === ''  || t.pop  == null) ? 'Îµ' : t.pop;
        let pushArr = Array.isArray(t.push)
          ? t.push
          : (typeof t.push === 'string' ? t.push.split('') : []);
        const push = pushArr.length ? pushArr.join('') : 'Îµ';

        const label = `${read} | ${pop}â†’${push}`;
        const kind = classifyEdgeKind(read, pop, pushArr);

        const tooltipText =
          `×§×¨×™××” (read): ${read === 'Îµ' ? 'Îµ (××¤×¡×™×œ×•×Ÿ)' : read}\n` +
          `×©×œ×™×¤×” (pop): ${pop === 'Îµ' ? '×œ×œ× ×©×œ×™×¤×” (Îµ)' : pop}\n` +
          `×“×—×™×¤×” (push): ${push === 'Îµ' ? '×œ× × ×“×—×£ ×“×‘×¨ (Îµ)' : push}`;

        elements.push({
          data: {
            id: `e${idx}`,
            source: t.from,
            target: t.to,
            label: label,
            tIndex: idx,
            kind: kind,
            tooltip: tooltipText
          }
        });
      });

      cy = cytoscape({
        container: cyDiv,
        elements,
        style: [
          {
            selector: 'node',
            style: {
              'background-color': '#6366f1',
              'label': 'data(label)',
              'color': '#fff',
              'text-valign': 'center',
              'text-halign': 'center',
              'font-size': '16px',
              'width': '55px',
              'height': '55px',
              'border-width': 2,
              'border-color': '#312e81'
            }
          },
          {
            selector: 'node.accept',
            style: {
              'border-width': 6,
              'border-color': '#22c55e',
              'background-color': '#bbf7d0',
              'color': '#065f46',
              'font-weight': 'bold'
            }
          },
          /* ×‘×¨×™×¨×ª ××—×“×œ */
          {
            selector: 'edge',
            style: {
              'curve-style': 'bezier',
              'target-arrow-shape': 'triangle',
              'target-arrow-color': '#4338ca',
              'line-color': '#6366f1',
              'width': 2,
              'label': 'data(label)',
              'font-size': '12px',
              'min-zoomed-font-size': 8,
              'edge-text-rotation': 'autorotate',
              'text-wrap': 'wrap',
              'text-max-width': 120,
              'text-background-color': '#ffffff',
              'text-background-opacity': 0.9,
              'text-background-padding': 4,
              'color': '#1f2937',
              'cursor': 'pointer'
            }
          },
          /* Îµ-transitions */
          {
            selector: 'edge[kind = "epsilon"]',
            style: {
              'line-color': '#f97316',
              'target-arrow-color': '#f97316',
              'color': '#f97316'
            }
          },
          /* pop only */
          {
            selector: 'edge[kind = "pop_only"]',
            style: {
              'line-color': '#ef4444',
              'target-arrow-color': '#ef4444',
              'color': '#ef4444'
            }
          },
          /* push only */
          {
            selector: 'edge[kind = "push_only"]',
            style: {
              'line-color': '#3b82f6',
              'target-arrow-color': '#3b82f6',
              'color': '#1d4ed8'
            }
          },
          /* push+pop */
          {
            selector: 'edge[kind = "pop_push"]',
            style: {
              'line-color': '#a855f7',
              'target-arrow-color': '#a855f7',
              'color': '#7e22ce'
            }
          }
        ],
        layout: { name: 'circle' }
      });

      cy.layout({ name: 'circle' }).run();
      cy.fit();
      cy.center();

      // ×§×œ×™×§ ×¢×œ ×§×©×ª â†’ ×”×“×’×©×ª ×©×•×¨×” ×‘×˜×‘×œ×” + ×”×§×©×ª
      cy.on('tap', 'edge', function (evt) {
        const tIndex = evt.target.data('tIndex');
        highlightTransition(tIndex);
      });

      // Tooltip ×¢×œ ×§×©×ª
      cy.on('mouseover', 'edge', function (evt) {
        const t = evt.target;
        const tooltipText = t.data('tooltip') || '';
        const e = evt.renderedPosition || evt.position;
        const clientX = evt.originalEvent ? evt.originalEvent.clientX : 0;
        const clientY = evt.originalEvent ? evt.originalEvent.clientY : 0;

        if (!tooltipText) return;
        edgeTooltip.textContent = tooltipText;
        edgeTooltip.style.left = clientX + 10 + 'px';
        edgeTooltip.style.top = clientY - 10 + 'px';
        edgeTooltip.style.opacity = '1';
        edgeTooltip.style.transform = 'translateY(0)';
      });

      cy.on('mouseout', 'edge', function () {
        edgeTooltip.style.opacity = '0';
        edgeTooltip.style.transform = 'translateY(-4px)';
      });

      // ×§×œ×™×§ ×¢×œ ××¦×‘ â†’ ××™×“×¢ ×‘×¦×“
      cy.on('tap', 'node', function (evt) {
        const node = evt.target;
        renderStateInfo(node.id());
      });
    }

    function renderTransitionTable(pda) {
      if (!transitionTableBody) return;
      const transitions = pda.transitions || [];
      if (!transitions.length) {
        transitionTableBody.innerHTML =
          '<tr><td colspan="6" class="px-3 py-2 text-gray-500 text-center">××™×Ÿ ××¢×‘×¨×™× ×œ×”×¦×™×’.</td></tr>';
        return;
      }

      transitionTableBody.innerHTML = transitions
        .map((t, idx) => {
          const read = (t.read === '' || t.read == null) ? 'Îµ' : t.read;
          const pop  = (t.pop === ''  || t.pop  == null) ? 'Îµ' : t.pop;
          let pushArr = Array.isArray(t.push)
            ? t.push
            : (typeof t.push === 'string' ? t.push.split('') : []);
          const push = pushArr.length ? pushArr.join('') : 'Îµ';

          return `
            <tr id="transition-row-${idx}"
                class="border-b last:border-0 transition-row cursor-pointer"
                onclick="onTransitionRowClick(${idx})">
              <td class="px-3 py-1">${idx}</td>
              <td class="px-3 py-1">${t.from}</td>
              <td class="px-3 py-1">${t.to}</td>
              <td class="px-3 py-1">${read}</td>
              <td class="px-3 py-1">${pop}</td>
              <td class="px-3 py-1">${push}</td>
            </tr>
          `;
        })
        .join('');
    }

    function clearEdgeHighlight() {
      if (!cy) return;
      cy.edges().removeClass('edge--active');
    }

    function highlightTransitionRow(index) {
      if (!transitionTableBody) return;
      const rows = transitionTableBody.querySelectorAll('.transition-row');
      rows.forEach(r => r.classList.remove('transition-row--active'));

      const targetRow = document.getElementById(`transition-row-${index}`);
      if (targetRow) {
        targetRow.classList.add('transition-row--active');
        targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    function highlightTransitionEdge(index) {
      if (!cy) return;
      clearEdgeHighlight();
      const edge = cy.edges().filter(e => e.data('tIndex') === index)[0];
      if (edge) {
        edge.addClass('edge--active');
        cy.center(edge);
      }
    }

    function highlightTransition(index) {
      highlightTransitionRow(index);
      highlightTransitionEdge(index);
    }

    // ×§×œ×™×§ ×¢×œ ×©×•×¨×” ×‘×˜×‘×œ×” â†’ ×”×“×’×©×ª ×§×©×ª
    function onTransitionRowClick(index) {
      highlightTransition(index);
    }

    window.onTransitionRowClick = onTransitionRowClick;

    function renderStateInfo(stateId) {
      if (!stateInfo || !currentPda || !cy) return;
      const isAccept = (currentPda.accept_states || []).includes(stateId);

      const outgoing = (currentPda.transitions || []).filter(t => t.from === stateId);
      const incoming = (currentPda.transitions || []).filter(t => t.to === stateId);

      const outgoingList = outgoing.map((t, idx) => {
        const read = (t.read === '' || t.read == null) ? 'Îµ' : t.read;
        const pop  = (t.pop === ''  || t.pop  == null) ? 'Îµ' : t.pop;
        let pushArr = Array.isArray(t.push)
          ? t.push
          : (typeof t.push === 'string' ? t.push.split('') : []);
        const push = pushArr.length ? pushArr.join('') : 'Îµ';
        return `(${read} | ${pop}â†’${push}) â†’ ${t.to}`;
      });

      const incomingList = incoming.map((t) => {
        const read = (t.read === '' || t.read == null) ? 'Îµ' : t.read;
        const pop  = (t.pop === ''  || t.pop  == null) ? 'Îµ' : t.pop;
        let pushArr = Array.isArray(t.push)
          ? t.push
          : (typeof t.push === 'string' ? t.push.split('') : []);
        const push = pushArr.length ? pushArr.join('') : 'Îµ';
        return `${t.from} â†’ (${read} | ${pop}â†’${push})`;
      });

      stateInfo.innerHTML = `
        <p><strong>×©× ×”××¦×‘:</strong> ${stateId}</p>
        <p class="mt-1"><strong>×¡×•×’:</strong> ${isAccept ? '××¦×‘ ××§×‘×œ âœ…' : '××¦×‘ ×¨×’×™×œ'}</p>
        <p class="mt-3"><strong>××¢×‘×¨×™× ×™×•×¦××™×:</strong></p>
        <ul class="list-disc pr-5 mt-1 text-xs md:text-sm">
          ${
            outgoingList.length
              ? outgoingList.map(x => `<li>${x}</li>`).join('')
              : '<li class="text-gray-500">××™×Ÿ ××¢×‘×¨×™× ×™×•×¦××™×.</li>'
          }
        </ul>
        <p class="mt-3"><strong>××¢×‘×¨×™× × ×›× ×¡×™×:</strong></p>
        <ul class="list-disc pr-5 mt-1 text-xs md:text-sm">
          ${
            incomingList.length
              ? incomingList.map(x => `<li>${x}</li>`).join('')
              : '<li class="text-gray-500">××™×Ÿ ××¢×‘×¨×™× × ×›× ×¡×™×.</li>'
          }
        </ul>
      `;
    }

    simulateForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!currentPda || currentPda.type !== 'PDA') {
        alert("×§×•×“× ×™×© ×œ×™×¦×•×¨ NPDA ××ª×™××•×¨ ×”×©×¤×”.");
        return;
      }

      const word = wordInput.value.trim();
      if (!word) {
        alert("×× × ×”×–×Ÿ ××—×¨×•×–×ª ×œ×‘×“×™×§×”.");
        return;
      }

      simulateResult.textContent = "â³ ××¨×™×¥ ×¡×™××•×œ×¦×™×”...";
      traceOutput.textContent = "";
      stackView.innerHTML = '<span class="text-gray-500">×˜×•×¢×Ÿ...</span>';
      stackView.classList.remove('stack-pop-flash');

      try {
        const res = await fetch('/pda/simulate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ word, pda: currentPda })
        });

        const data = await res.json();

        if (data.error) {
          simulateResult.textContent = data.error;
          return;
        }

        if (data.accepted) {
          simulateResult.textContent = "âœ… ×”××—×¨×•×–×ª ×”×ª×§×‘×œ×” ×¢×œ ×™×“×™ ×”-NPDA.";
          simulateResult.className = "mt-4 text-lg font-semibold text-green-700";
        } else {
          simulateResult.textContent = "âŒ ×”××—×¨×•×–×ª × ×“×—×ª×” ×¢×œ ×™×“×™ ×”-NPDA.";
          simulateResult.className = "mt-4 text-lg font-semibold text-red-700";
        }

        traceOutput.textContent = buildTraceText(data.trace || []);
        updateStackView(data.trace || []);
      } catch (err) {
        console.error(err);
        simulateResult.textContent = "âŒ ×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª.";
        simulateResult.className = "mt-4 text-lg font-semibold text-red-700";
      }
    });

    function buildTraceText(trace) {
      if (!trace.length) {
        return "××™×Ÿ Trace ×œ×”×¦×’×”.";
      }
      return trace
        .map(step =>
          `×¦×¢×“ ${step.step} | ××¦×‘: ${step.state} | × ×§×¨×: "${step.consumed}" | × ×•×ª×¨ ×§×œ×˜: "${step.remaining_input}" | ××—×¡× ×™×ª: [${(step.stack || []).join(", ")}]`
        )
        .join("\n");
    }

    function updateStackView(trace) {
      if (!trace.length) {
        stackView.innerHTML = '<span class="text-gray-500">××™×Ÿ ××™×“×¢ ×¢×œ ××—×¡× ×™×ª.</span>';
        return;
      }
      const last = trace[trace.length - 1];
      const stack = last.stack || [];

      const oldStack = prevStackForAnimation || [];
      prevStackForAnimation = [...stack];

      if (!stack.length) {
        stackView.innerHTML = '<span class="text-gray-700">×”××—×¡× ×™×ª ×¨×™×§×”.</span>';
        stackView.classList.add('stack-pop-flash');
        setTimeout(() => stackView.classList.remove('stack-pop-flash'), 300);
        return;
      }

      stackView.innerHTML = "";
      const label = document.createElement("span");
      label.className = "text-gray-700 mr-2 mb-2";
      label.textContent = "××œ××¢×œ×” ×œ××˜×”:";
      stackView.appendChild(label);

      const isPush = stack.length > oldStack.length;
      const isPop  = stack.length < oldStack.length;

      stack.forEach((sym, idx) => {
        const span = document.createElement("span");
        span.className = "stack-badge" + (idx === stack.length - 1 ? " stack-badge-bottom" : "");
        span.textContent = sym;

        if (isPush && idx >= oldStack.length) {
          span.classList.add('stack-push');
        }

        stackView.appendChild(span);
      });

      if (isPop) {
        stackView.classList.add('stack-pop-flash');
        setTimeout(() => stackView.classList.remove('stack-pop-flash'), 300);
      }
    }

    // ×™×¦×•× ×ª××•× ×ª PNG
    exportPngBtn.addEventListener('click', () => {
      if (!cy) {
        alert("×§×•×“× ×¦×•×¨ NPDA ×›×“×™ ×œ×™×™×¦× ×’×¨×£.");
        return;
      }
      const pngData = cy.png({ full: true });
      const link = document.createElement('a');
      link.href = pngData;
      link.download = 'npda_graph.png';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
  </script>
</body>
</html>
